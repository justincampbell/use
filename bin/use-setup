#!/bin/bash

USE_DIR=${USE_DIR:-$HOME/.use}
USE_ENV_PATTERNS=(
  AWS
  EC2
  FOG
  KNIFE
  OPSCODE
)
USE_VERSION="0.0.1"

use_help() {
  echo "use $USE_VERSION"
  echo "github.com/justincampbell/use"
  echo ""
  echo "Usage:"
  echo "  use                 reset, source home profile"
  echo "  use my_company      reset, source home and my_company profiles"
  echo "  use help            show this help"
  echo "  use version         show the version"
  echo ""
}

use_unalias() {
  unalias -a
}

use_unset_env_vars() {
  for env_var in $(env | cut -f 1 -d "=" | sort); do
    for pattern in "${USE_ENV_PATTERNS[@]}"; do
      if [[ $env_var =~ $pattern ]]; then
        unset $env_var
      fi
    done
  done
}

use_home() {
  source $HOME/.profile
}

use_company() {
  if [[ "$1" != "" ]]; then
    USE_PROFILE=$USE_DIR/$1/.profile

    if [[ ! -f $USE_PROFILE ]]; then
      echo "$USE_PROFILE not found"
      return 1
    fi

    source $USE_PROFILE
  fi
}

use() {
  if [[ "$@" == *-h* ]] || [[ "$1" == "help" ]]; then
    use_help
    return 0
  fi

  if [[ "$1" == "version" ]]; then
    echo $USE_VERSION
    return 0
  fi

  use_unalias
  use_unset_env_vars
  use_home
  use_company $1
}
